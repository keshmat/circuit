---
export const lang = "ts";

import Layout from "../../layouts/Layout.astro";
import { getDb, type TournamentResult } from "../../lib/db";
import TournamentTable from "../../components/TournamentTable.astro";

export async function getStaticPaths() {
  const months = ["january", "february", "march", "july", "august", "december"];
  return months.map((month) => ({
    params: { month },
    props: { month },
  }));
}

const { month } = Astro.props;
const db = await getDb();

// Get tournament results for the specified month
const results = await db.all<TournamentResult[]>(
  `
  SELECT 
    p.name,
    tr.points,
    (SELECT COUNT(*) FROM games g 
     WHERE (g.white_player_id = p.id OR g.black_player_id = p.id) 
     AND g.tournament_id = t.id) as games_played,
    (SELECT COUNT(*) FROM games g 
     WHERE ((g.white_player_id = p.id AND g.result = '1-0') OR 
            (g.black_player_id = p.id AND g.result = '0-1') OR
            (g.white_player_id = p.id AND g.result = '1-0+') OR
            (g.black_player_id = p.id AND g.result = '0-1+'))
     AND g.tournament_id = t.id) as wins,
    (SELECT COUNT(*) FROM games g 
     WHERE ((g.white_player_id = p.id AND g.result = '0-1') OR 
            (g.black_player_id = p.id AND g.result = '1-0'))
     AND g.tournament_id = t.id) as losses,
    (SELECT COUNT(*) FROM games g 
     WHERE g.result = '1/2-1/2' 
     AND (g.white_player_id = p.id OR g.black_player_id = p.id)
     AND g.tournament_id = t.id) as draws,
    pr.performance_rating as performance
  FROM tournaments t
  JOIN tournament_results tr ON t.id = tr.tournament_id
  JOIN players p ON tr.player_id = p.id
  LEFT JOIN performance_ratings pr ON p.id = pr.player_id AND pr.tournament_id = t.id
  WHERE LOWER(t.name) LIKE ?
  ORDER BY tr.points DESC
`,
  [`%${month}%`]
);
---

<Layout title={`${month.charAt(0).toUpperCase() + month.slice(1)} Tournament`}>
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8">
      {month.charAt(0).toUpperCase() + month.slice(1)} Tournament
    </h1>

    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4">Tournament Results</h2>
      <TournamentTable records={results} />
    </section>
  </main>
</Layout>
